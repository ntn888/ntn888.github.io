<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>Venturing into freeBSD: Homeserver attempt 2</title><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=https://fonts.googleapis.com rel=preconnect><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=Signika&display=swap" rel=stylesheet><style>body{--primary-color:#698bcf;--primary-pale-color:#698bcf1c;--text-color:#3c4043;--text-pale-color:#9aa2b9;--bg-color:#fff;--highlight-mark-color:#5f75b045;--callout-note-color:#698bcf;--callout-important-color:#9971d9;--callout-warning-color:#c99054;--callout-alert-color:#d35757;--callout-question-color:#4985a2;--callout-tip-color:#3ea06f;--main-font:'Signika',ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--code-font:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--homepage-max-width:750px;--main-max-width:750px;--avatar-size:70px;--paragraph-font-size:18px;--paragraph-line-height:1.75;--aside-font-size:16px;--img-border-radius:0;--inline-code-border-radius:2px}body.dark{--primary-color:#698bcf;--primary-pale-color:#698bcf1c;--text-color:#9197a5;--text-pale-color:#5d6470;--bg-color:#202124;--highlight-mark-color:#5f75b045;--callout-note-color:#698bcf;--callout-important-color:#9971d9;--callout-warning-color:#c99054;--callout-alert-color:#d35757;--callout-question-color:#4985a2;--callout-tip-color:#3ea06f}</style><link href=/main.css rel=stylesheet><link href=/hl-light.css id=hl rel=stylesheet><script data-domain=ntn888.github.io defer src=https://mypa.simplycreate.xyz/js/script.js></script><body class=post><script>if(localStorage.getItem('theme')=='dark'){document.body.classList.add('dark');const a=document.querySelector('link#hl');if(a)a.href='/hl-dark.css'}</script><header class=blur><div id=header-wrapper><nav><a href=/>ajit</a><span class=separator>::</span><a href=/blog>blog</a></nav><div id=btns><a aria-label="rss feed" href=/feed.xml><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M3 17C5.20914 17 7 18.7909 7 21H3V17ZM3 10C9.07513 10 14 14.9249 14 21H12C12 16.0294 7.97056 12 3 12V10ZM3 3C12.9411 3 21 11.0589 21 21H19C19 12.1634 11.8366 5 3 5V3Z" fill=currentColor></path></svg></a><button aria-label="theme switch" data-moon-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill="currentColor"></path></svg>' data-sun-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill="currentColor"></path></svg>' id=theme-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></button><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><div id=wrapper><div id=blank></div><aside class=blur><nav><ul><li><a class=h2 href=#why-freebsd>Why freeBSD?</a><li><a class=h2 href=#hw-setup>HW setup</a><li><a class=h2 href=#sw-setup>SW setup</a> <ul><li><a class=h3 href=#pre-requisites>Pre-requisites</a><li><a class=h3 href=#zfs-setup>ZFS setup</a><li><a class=h3 href=#bastille-jails-setup>Bastille jails setup</a></ul><li><a class=h2 href=#templates-dump>Templates dump</a></ul></nav><button aria-label="back to top" id=back-to-top><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M11.9997 10.8284L7.04996 15.7782L5.63574 14.364L11.9997 8L18.3637 14.364L16.9495 15.7782L11.9997 10.8284Z" fill=currentColor></path></svg></button></aside><main><div><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' id=copy-cfg style=display:none></div><article data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z" fill="currentColor"></path></svg>' class=prose><h1>Venturing into freeBSD: Homeserver attempt 2</h1><div id=post-info><div id=date><span id=publish>2024-05-19</span></div><div id=tags><a href=https://ntn888.github.io//tags/nas><span>#</span>NAS</a><a href=https://ntn888.github.io//tags/self-host><span>#</span>self-host</a><a href=https://ntn888.github.io//tags/seedbox><span>#</span>seedbox</a></div></div><h1 id=why-freebsd>Why freeBSD?<a aria-label="Anchor link for: why-freebsd" class=zola-anchor href=#why-freebsd>#</a></h1><p>ZFS. raidz2 recommended but we will use raidz1 in our experiment! <a rel="nofollow noreferrer" href=https://arstechnica.com/information-technology/2020/05/zfs-101-understanding-zfs-storage-and-performance/>Link</a> for more info.<h1 id=hw-setup>HW setup<a aria-label="Anchor link for: hw-setup" class=zola-anchor href=#hw-setup>#</a></h1><p>Here are the main parts for the build:<ul><li><a rel="nofollow noreferrer" href=https://www.aliexpress.com/item/1005006221619148.html>N5105 Motherboard</a> (CPU attached)<li><a rel="nofollow noreferrer" href=https://www.aliexpress.com/item/1005001370106988.html>Innovision 4bay NAS case</a> comes with individual HDD bay LEDs! Spectacle when they spin up!</ul><p>The N5105 is an Intel Celeron chip with a TDP of just 10W (in the RPI range..). It also has the QuickSync feature for hardware assisted Plex transcoding. :)<p>I got an 8GB RAM. The board accepts DDR4 Laptop SO-DIMM sticks. And also got a 120GB NVME SSD for the boot drive.<p>The case comes with the PSU included. SAS HDDs are cheaper, but I wasn't sure if the case support them. So went for 4x SATA 4TB ones.<h1 id=sw-setup>SW setup<a aria-label="Anchor link for: sw-setup" class=zola-anchor href=#sw-setup>#</a></h1><p>As mentioned we'll be using freeBSD. This OS does not support docker. But has the concept of <em>Jails</em>. It is the same principle (container isolation) but predates docker.<p>Using a <em>jail manager</em> provides a simpler interface to managing jails. We'll use the <em>bastille</em> jail manager. For the following features:<ul><li>auto NAT! (using PF; whole new rabbithole; we'll learn just enough to get by..)<li>easy and intuitive recipes/templates to automate spinning up jails (very useful in our complex case!)</ul><p>We'll use no hostname resolution. Instead we'll refer each app using it's jail's hardcoded IPs (that's internally NAT'd)<h2 id=pre-requisites>Pre-requisites<a aria-label="Anchor link for: pre-requisites" class=zola-anchor href=#pre-requisites>#</a></h2><p>We add our user to sudo. In this article I'll be referring to user <code>ajit</code> as the main user. The username doesn't matter, what's important is the <code>uid</code>. I've set this to <code>1001</code> to be consistent with the default first user created in freeBSD host. See the templates below for clarity.<p>Remember to add this user to group <code>wheel</code> when you install the host system or afterwards. Then:<pre class=z-code><code><span class="z-text z-plain">su -
install pkg sudo
visudo
</span></code></pre><p>Uncomment the %wheel so it looks like this :<pre class=z-code><code><span class="z-text z-plain">## Allows people in group wheel to run all commands
%wheel    ALL=(ALL)   ALL
</span></code></pre><p>We have to enable mDNS so that our server can be reachable using it's hostname (eg freesrv.local):<pre class=z-code><code><span class="z-text z-plain">sudo pkg install openmdns

sudo sysrc mdnsd_enable=yes
sudo sysrc mdnsd_flags=igc0 #indicate eth interface
sudo service mdnsd start

</span></code></pre><p>In the flag above replace <code>igc0</code> with your ethernet interface.<p>Enable <code>powerd</code> to make the system run more power efficient. See <a rel="nofollow noreferrer" href=https://bastian.rieck.me/blog/2013/freebsd_nas_part_ii/>here</a>.<h2 id=zfs-setup>ZFS setup<a aria-label="Anchor link for: zfs-setup" class=zola-anchor href=#zfs-setup>#</a></h2><p>We begin by setting up our ZFS storage. Refer the <a rel="nofollow noreferrer" href=https://docs.freebsd.org/en/books/handbook/zfs/>handbook</a> and create <code>media</code> and <code>appdata</code> datasets. Now create the following directory structure:<pre class=z-code><code><span class="z-text z-plain">cd <..>/media
mkdir medialibrary
mkdir medialibrary/movies
mkdir medialibrary/tv
mkdir torrents

cd <..>/appdata
mkdir radarr sonarr sabnzbd

</span></code></pre><p>After initialised, I was left with 10TB usable storage!<h2 id=bastille-jails-setup>Bastille jails setup<a aria-label="Anchor link for: bastille-jails-setup" class=zola-anchor href=#bastille-jails-setup>#</a></h2><p>Run this to automatically setup bastille. It'll also setup PF with rule for ssh.<pre class=z-code><code><span class="z-text z-plain">sudo bastille setup
</span></code></pre><p>If you have external ZFS mounts on your system but want bastille to use the UFS filesystem (used by root):<pre class=z-code><code><span class="z-text z-plain">sudo bastille setup ufs
</span></code></pre><p>We also need to allow mDNS (hostname resolution). To do this add the following to the <code>/etc/pf.conf</code>:<pre class=z-code><code><span class="z-text z-plain">pass in inet proto udp from any to any port = 5353 keep state
</span></code></pre><p>Now:<pre class=z-code><code><span class="z-text z-plain">sudo service pf start
</span></code></pre><p>You will need to re-initiate the ssh connection.<p>Finally to setup the jails issue the following commands (templates at the end of this article):<pre class=z-code><code><span class="z-text z-plain">sudo bastille create radarrJail 14.0-RELEASE 10.17.89.50
sudo bastille template radarrJail bastillebsd-templates/radarr

sudo bastille create sonarrJail 14.0-RELEASE 10.17.89.51
sudo bastille template radarrJail bastillebsd-templates/sonarr

sudo bastille create sabnzbdJail 14.0-RELEASE 10.17.89.52
sudo bastille template radarrJail bastillebsd-templates/sabnzbd

sudo bastille create jellyfinJail 14.0-RELEASE 10.17.89.53
sudo bastille template radarrJail bastillebsd-templates/jellyfin

sudo bastille create homerJail 14.0-RELEASE 10.17.89.54
sudo bastille template homerJail bastillebsd-templates/homer
</span></code></pre><p>If everything goes to plan, you should have an accessible *ARR suite running, with the correct permisions.<p>Additional NOTE: Set the media files to be globally readable. This is so that we can run <code>jellyfin</code> as any user. Goto Radarr Settings -> Media Management (Show Advanced) -> Permissions -> Set Permissions (checked) -> chmod Folder [755].<p>TODO: Implement the equivalent of <em>Watchtowerr</em> application that auto updates the container packages on a periodic basis (ie weekly). To achieve this I could incorporate the cron and some shell scripting (but my scripting skills are not upto scratch). A rudimentary approach is outlined in this <a rel="nofollow noreferrer" href=https://forums.FreeBSD.org/threads/is-it-possible-to-pkg-update-upgrade-all-jails-in-one-go.39446/post-219246>forum post</a>. Unfortunately it restarts the containers regardless if there was an update, which I think is wasteful.<h1 id=templates-dump>Templates dump<a aria-label="Anchor link for: templates-dump" class=zola-anchor href=#templates-dump>#</a></h1><p>radarr:<pre class=z-code><code><span class="z-text z-plain">CMD pw useradd -u 1001 -n ajit -c "Ajit" -s csh -m -w random
CMD mkdir /mnt/media

CONFIG set allow.mlock=1;
CONFIG set ip6=inherit;
RDR tcp 7878 7878
RESTART

PKG radarr
MOUNT /storage/appdata/radarr /usr/local/radarr nullfs rw 0 0
MOUNT /storage/media /mnt/media nullfs rw 0 0
RESTART

SYSRC radarr_enable="YES"
SERVICE radarr start
CMD chown -R ajit:ajit /var/run/radarr
CMD sed -i -r s'/radarr_user:="radarr"/radarr_user:="ajit"/' /usr/local/etc/rc.d/radarr
CMD sed -i -r s'/radarr_group:="radarr"/radarr_group:="ajit"/' /usr/local/etc/rc.d/radarr
SERVICE radarr restart

</span></code></pre><p>sonarr:<pre class=z-code><code><span class="z-text z-plain">CMD pw useradd -u 1001 -n ajit -c "Ajit" -s csh -m -w random
CMD mkdir /mnt/media

CONFIG set allow.mlock=1;
CONFIG set ip6=inherit;
RDR tcp 8989 8989
RESTART

PKG sonarr
MOUNT /storage/appdata/sonarr /usr/local/sonarr nullfs rw 0 0
MOUNT /storage/media /mnt/media nullfs rw 0 0
RESTART

SYSRC sonarr_enable="YES"
SERVICE sonarr start
CMD chown -R ajit:ajit /var/run/sonarr
CMD sed -i -r s'/sonarr_user:="sonarr"/sonarr_user:="ajit"/' /usr/local/etc/rc.d/sonarr
CMD sed -i -r s'/sonarr_group:="sonarr"/sonarr_group:="ajit"/' /usr/local/etc/rc.d/sonarr
SERVICE sonarr restart

</span></code></pre><p>sabnzbd:<pre class=z-code><code><span class="z-text z-plain">CMD pw useradd -u 1001 -n ajit -c "Ajit" -s csh -m -w random
CMD mkdir -p /mnt/media/torrents

CONFIG set ip6=inherit;
RDR tcp 8080 8080
RESTART

PKG sabnzbd
MOUNT /storage/appdata/sabnzbd /usr/local/sabnzbd nullfs rw 0 0
MOUNT /storage/media/torrents /mnt/media/torrents nullfs rw 0 0
RESTART

SYSRC sabnzbd_enable="YES"
SERVICE sabnzbd start
CMD chown -R ajit:ajit /var/run/sabnzbd
CMD sed -i -r s'/sabnzbd_user:=_sabnzbd/sabnzbd_user:="ajit"/' /usr/local/etc/rc.d/sabnzbd
CMD sed -i -r s'/sabnzbd_group:=_sabnzbd/sabnzbd_group:="ajit"/' /usr/local/etc/rc.d/sabnzbd
SERVICE sabnzbd restart

</span></code></pre><p>jellyfin:<pre class=z-code><code><span class="z-text z-plain">CMD mkdir -p /mnt/data/movies
CMD mkdir -p /mnt/data/tv

CMD mkdir -p /usr/local/etc/pkg/repos
CMD echo 'FreeBSD: { url: "pkg+http://pkg.FreeBSD.org/${ABI}/latest" }' > /usr/local/etc/pkg/repos/FreeBSD.conf
CONFIG set allow.mlock=1;
CONFIG set ip6=inherit;
RDR tcp 8096 8096
RESTART

PKG jellyfin
MOUNT /storage/media/medialibrary/movies /mnt/data/movies nullfs rw 0 0
MOUNT /storage/media/medialibrary/tv /mnt/data/tv nullfs rw 0 0
RESTART

SYSRC jellyfin_enable="YES"
SERVICE jellyfin start

</span></code></pre><p>homer:<pre class=z-code><code><span class="z-text z-plain">CONFIG set ip6=inherit;
RDR tcp 80 80
RESTART

PKG apache24

CMD curl -LO https://github.com/bastienwirtz/homer/releases/latest/download/homer.zip
CMD unzip -o homer.zip -d /usr/local/www/apache24/data
CMD cp /usr/local/www/apache24/data/assets/config.yml.dist /usr/local/www/apache24/data/assets/config.yml
CP config.yml /usr/local/www/apache24/data/assets/

SYSRC apache24_enable="YES"
SYSRC apache24_flags=""
CMD httpd -t
SERVICE apache24 start

</span></code></pre><p>homer <code>config.yml</code>. Place this file beside the homer template.<pre class=z-code><code><span class="z-text z-plain">---
# Homepage configuration
# See https://fontawesome.com/v5/search for icons options

title: "FreeSRV dashboard"
subtitle: "Homer"
logo: "logo.png"
# icon: "fas fa-skull-crossbones" # Optional icon

header: true
footer: '&LTp>Created with &LTspan class="has-text-danger">❤️&LT/span> with &LTa href="https://bulma.io/">bulma&LT/a>, &LTa href="https://vuejs.org/">vuejs&LT/a> & &LTa href="https://fontawesome.com/">font awesome&LT/a> // Fork me on &LTa href="https://github.com/bastienwirtz/homer">&LTi class="fab fa-github-alt">&LT/i>&LT/a>&LT/p>' # set false if you want to hide it.

# Optional theme customization
theme: default
colors:
  light:
    highlight-primary: "#3367d6"
    highlight-secondary: "#4285f4"
    highlight-hover: "#5a95f5"
    background: "#f5f5f5"
    card-background: "#ffffff"
    text: "#363636"
    text-header: "#ffffff"
    text-title: "#303030"
    text-subtitle: "#424242"
    card-shadow: rgba(0, 0, 0, 0.1)
    link: "#3273dc"
    link-hover: "#363636"
  dark:
    highlight-primary: "#3367d6"
    highlight-secondary: "#4285f4"
    highlight-hover: "#5a95f5"
    background: "#131313"
    card-background: "#2b2b2b"
    text: "#eaeaea"
    text-header: "#ffffff"
    text-title: "#fafafa"
    text-subtitle: "#f5f5f5"
    card-shadow: rgba(0, 0, 0, 0.4)
    link: "#3273dc"
    link-hover: "#ffdd57"

# Optional navbar
# links: [] # Allows for navbar (dark mode, layout, and search) without any links
links:
  - name: "Contribute"
    icon: "fab fa-github"
    url: "https://github.com/bastienwirtz/homer"
    target: "_blank" # optional html a tag target attribute
  - name: "Wiki"
    icon: "fas fa-book"
    url: "https://www.wikipedia.org/"
  # this will link to a second homer page that will load config from additional-page.yml and keep default config values as in config.yml file
  # see url field and assets/additional-page.yml.dist used in this example:
  #- name: "another page!"
  #  icon: "fas fa-file-alt"
  #  url: "#additional-page" 

# Services
# First level array represent a group.
# Leave only a "items" key if not using group (group name, icon & tagstyle are optional, section separation will not be displayed).
services:
  - name: "Applications"
    icon: "fas fa-cloud"
    items:
      - name: "Jellyfin"
        logo: "assets/tools/sample2.png"
        subtitle: "Media Player"
        tag: "app"
        url: "http://freesrv.local:8096/"
        target: "_blank" # optional html a tag target attribute
      - name: "Radarr"
        logo: "assets/tools/sample.png"
        subtitle: "Movies"
        tag: "app"
        url: "http://freesrv.local:7878/"
        target: "_blank" # optional html a tag target attribute
      - name: "Sonarr"
        logo: "assets/tools/sample.png"
        subtitle: "TV"
        tag: "app"
        url: "http://freesrv.local:8989/"
        target: "_blank" # optional html a tag target attribute
      - name: "Sabnzbd"
        logo: "assets/tools/sample.png"
        subtitle: "Usenet"
        tag: "app"
        url: "http://freesrv.local:8080/"
        target: "_blank" # optional html a tag target attribute
      
</span></code></pre></article></div><footer><div class=copyright><p>© 2023 Ajit</div><div class=credits>powered by <a rel="noreferrer noopener" href=https://www.getzola.org target=_blank>zola</a> and <a rel="noreferrer noopener" href=https://github.com/isunjn/serene target=_blank>serene</a></div></footer></main></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>